<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="https://buehlmaier.github.io/MFIN7036-student-blog-2025-12/theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://buehlmaier.github.io/MFIN7036-student-blog-2025-12/theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="MFIN7036 Students 2025" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content=", Reflective Report, " />

<meta property="og:title" content="PolicyPulse： From Words to Warning Signals "/>
<meta property="og:url" content="https://buehlmaier.github.io/MFIN7036-student-blog-2025-12/policypulse-from-words-to-warning-signals.html" />
<meta property="og:description" content="Step 1 Data Collection 1.1. Introduction In this session, I will walk you through my journey of collecting central bank speech data from the Bank for International Settlements (BIS) website. This work was part of our PolicyPulse: From Words to Warning Signals, a project of financial text analytics and …" />
<meta property="og:site_name" content="MFIN7036 Student Blog 2025" />
<meta property="og:article:author" content="MFIN7036 Students 2025" />
<meta property="og:article:published_time" content="2026-01-21T00:00:00+08:00" />
<meta name="twitter:title" content="PolicyPulse： From Words to Warning Signals ">
<meta name="twitter:description" content="Step 1 Data Collection 1.1. Introduction In this session, I will walk you through my journey of collecting central bank speech data from the Bank for International Settlements (BIS) website. This work was part of our PolicyPulse: From Words to Warning Signals, a project of financial text analytics and …">

        <title>PolicyPulse： From Words to Warning Signals  · MFIN7036 Student Blog 2025
</title>
        <link href="https://buehlmaier.github.io/MFIN7036-student-blog-2025-12/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="MFIN7036 Student Blog 2025 - Full Atom Feed" />



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://buehlmaier.github.io/MFIN7036-student-blog-2025-12/"><span class=site-name>MFIN7036 Student Blog 2025</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://buehlmaier.github.io/MFIN7036-student-blog-2025-12
                                    >Home</a>
                                </li>
                                <li ><a href="https://buehlmaier.github.io/MFIN7036-student-blog-2025-12/categories.html">Categories</a></li>
                                <li ><a href="https://buehlmaier.github.io/MFIN7036-student-blog-2025-12/tags.html">Tags</a></li>
                                <li ><a href="https://buehlmaier.github.io/MFIN7036-student-blog-2025-12/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="https://buehlmaier.github.io/MFIN7036-student-blog-2025-12/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://buehlmaier.github.io/MFIN7036-student-blog-2025-12/policypulse-from-words-to-warning-signals.html">
                PolicyPulse： From Words to Warning Signals
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <h2>Step 1 Data Collection</h2>
<h3>1.1. Introduction</h3>
<p><em>In this session, I will walk you through my journey of collecting central bank speech data from the Bank for International Settlements (BIS) website. This work was part of our PolicyPulse: From Words to Warning Signals, a project of financial text analytics and NLP. I will discuss the initial challenges, the pivots in approach, and the final solution that combined bulk downloads with an undocumented API.</em></p>
<p>In our group project, we aimed to analyze the textual content of speeches delivered by central bank officials from around the world. The BIS website serves as a rich repository of such speeches, making it an ideal data source. My responsibility was to collect a comprehensive dataset spanning from 2008 to 2019, including metadata such as:</p>
<ul>
<li>Speech title</li>
<li>Speaker</li>
<li>Central bank (institution)</li>
<li>Date</li>
<li>Venue</li>
<li>Full text</li>
<li>PDF file size and page count</li>
<li>Language</li>
<li>Category tags</li>
</ul>
<p>This blog documents the process, the hurdles, and the eventual solution that enabled us to gather this data efficiently.</p>
<hr>
<h3>1.2. Initial Approach: Direct Web Scraping</h3>
<p>My first instinct was to scrape the BIS speeches index page:  <code>https://www.bis.org/cbspeeches/index.htm</code></p>
<p>I noticed that the page allowed filtering by date, and the URL structure was predictable:
<code>https://www.bis.org/cbspeeches/index.htm?fromDate=01%2F01%2F2008&amp;tillDate=01%2F02%2F2008&amp;cbspeeches_page=2</code></p>
<p>My plan was straightforward:</p>
<ol>
<li>Dynamically generate URLs for each month and page within our date range.</li>
<li>Parse each page to extract links to individual speech pages.</li>
<li>Visit each speech page, scrape metadata, and download the PDF.</li>
</ol>
<h4>The Challenge: Dynamic Content Loading</h4>
<p>However, when I used <code>requests</code> to fetch the HTML, I found that the speech links were missing from the source. After inspecting the page with browser developer tools, I realized that the table of speeches was loaded dynamically via JavaScript. This meant that static scraping with requests would not work.</p>
<p>At this point, I considered using <strong>Selenium</strong> to simulate a browser and interact with the page. While feasible, this approach would be slow and resource-intensive for a large date range (2008–2019), especially since each page displayed only 10 speeches.</p>
<p>Here’s a snippet from my notes at the time, outlining the initial plan:</p>
<ol>
<li>
<p>Start from the filtered index page (with date range).</p>
</li>
<li>
<p>Dynamically crawl each page (using Selenium) to extract speech links.</p>
</li>
<li>
<p>For each speech, extract the unique code (e.g., "r251211d") from the link.</p>
</li>
<li>
<p>Construct an API URL: https://www.bis.org/api/documents/review/r251211d.json</p>
</li>
<li>
<p>Fetch metadata from the JSON API.</p>
</li>
<li>
<p>Download the PDF and extract text.</p>
</li>
<li>
<p>Combine all information into a structured format.</p>
</li>
</ol>
<hr>
<h3>1.3. The Turning Point: Bulk Download and Hidden API</h3>
<p>While exploring the BIS website further, I discovered a <strong>bulk download page</strong>:  <code>https://www.bis.org/cbspeeches/download.htm</code></p>
<p>This page offered a CSV file (like <code>speeches_2008.csv</code>) containing a list of speeches with basic metadata:</p>
<ul>
<li>Text</li>
<li>Title</li>
<li>Speaker</li>
<li>Date</li>
<li>PDF URL</li>
</ul>
<p>This was a game-changer. With permission from our professor, I downloaded this CSV, which covered all speeches from 2008 to 2019 in one go. However, the CSV was missing several important fields:</p>
<ul>
<li>Institution number and name</li>
<li>Language</li>
<li>PDF file size and page count</li>
<li>Category (recurse_category)</li>
<li>Source information</li>
</ul>
<p>Fortunately, during my earlier exploration, I had noticed that each speech had an associated JSON file accessible via an <strong>undocumented API</strong>:
<code>https://www.bis.org/api/documents/review/{speech_code}.json</code></p>
<p>Where <code>{speech_code}</code> is the unique identifier (e.g., <code>r251211d</code>). This API returned all the missing fields.</p>
<p>Thus, I devised a two-step strategy:</p>
<ol>
<li><strong>Use the bulk CSV</strong> to get the list of speeches and their basic metadata.</li>
<li><strong>Enrich each record</strong> by calling the JSON API to fetch additional details.</li>
</ol>
<hr>
<h3>1.4. Implementation: The Python Script</h3>
<p>I wrote a Python script (<code>bis_processor.py</code>) to automate this process. Below, I’ll explain the key components.</p>
<h4>1.4.1 Setting Up the Environment</h4>
<p>The script uses several libraries for HTTP requests, JSON handling, and progress tracking.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">urllib3.util.retry</span> <span class="kn">import</span> <span class="n">Retry</span>
<span class="kn">from</span> <span class="nn">requests.adapters</span> <span class="kn">import</span> <span class="n">HTTPAdapter</span>
</code></pre></div>

<h4>1.4.2 Robust HTTP Requests</h4>
<p>To handle network issues and avoid being blocked, I set up a session with retry logic and custom headers.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Define custom headers for HTTP requests</span>
<span class="n">HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Configure a session with retry logic</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
<span class="n">retries</span> <span class="o">=</span> <span class="n">Retry</span><span class="p">(</span>
    <span class="n">total</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  
    <span class="n">backoff_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  
    <span class="n">status_forcelist</span><span class="o">=</span><span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">504</span><span class="p">],</span>  <span class="c1"># Retry on these HTTP status codes</span>
<span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s2">&quot;https://&quot;</span><span class="p">,</span> <span class="n">HTTPAdapter</span><span class="p">(</span><span class="n">max_retries</span><span class="o">=</span><span class="n">retries</span><span class="p">))</span>
</code></pre></div>

<h4>1.4.3 Extracting the Speech Code</h4>
<p>From the PDF URL in the CSV, I extracted the unique speech code.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">extract_unique_code</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract the unique code from the URL.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>

<h4>1.4.4 Fetching Document Details</h4>
<p>This function calls the BIS API and parses the JSON response. It includes error handling and a fallback for a common URL pattern.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">fetch_document_details</span><span class="p">(</span><span class="n">api_url</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch the JSON data from the API and extract relevant details.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">HEADERS</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">authors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;authors&quot;</span><span class="p">)</span>
        <span class="n">author_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">author</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">authors</span><span class="p">]</span> <span class="k">if</span> <span class="n">authors</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;institutions&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;institutions&quot;</span><span class="p">),</span>
            <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">),</span>
            <span class="s2">&quot;pdf_file_size&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pdf_file_size&quot;</span><span class="p">),</span>
            <span class="s2">&quot;pdf_pages&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pdf_pages&quot;</span><span class="p">),</span>
            <span class="s2">&quot;sources&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sources&quot;</span><span class="p">),</span>
            <span class="s2">&quot;recurse_category&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;recurse_category&quot;</span><span class="p">),</span>
            <span class="s2">&quot;author_id&quot;</span><span class="p">:</span> <span class="n">author_ids</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="c1"># Modify the URL to include an additional suffix and retry</span>
            <span class="n">modified_api_url</span> <span class="o">=</span> <span class="n">api_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;.a.json&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">modified_api_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">HEADERS</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="n">authors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;authors&quot;</span><span class="p">)</span>
                <span class="n">author_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">author</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">authors</span><span class="p">]</span> <span class="k">if</span> <span class="n">authors</span> <span class="k">else</span> <span class="p">[]</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;institutions&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;institutions&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;pdf_file_size&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pdf_file_size&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;pdf_pages&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pdf_pages&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;sources&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sources&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;recurse_category&quot;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;recurse_category&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;author_id&quot;</span><span class="p">:</span> <span class="n">author_ids</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">retry_error</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching data from </span><span class="si">{</span><span class="n">modified_api_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">retry_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching data from </span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching data from </span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>

<h4>1.4.5 Mapping Institution Numbers to Names</h4>
<p>The BIS API returns institution numbers, not names. I used a local <code>institutions.json</code> file, which was also from an undocumented API, to map these numbers to human-readable names.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">load_institutions_map</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the institutions.json file and create a mapping of id to name.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">institutions_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">institutions_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected a dictionary in institutions.json&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">institutions_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">}</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error decoding JSON from </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error with data structure in </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
</code></pre></div>

<h4>1.4.6 Main Processing Loop</h4>
<p>The script reads the CSV, iterates through each row, enriches the data via the API, and writes the output as JSON.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">process_csv</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process the CSV file and generate the final JSON data.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_file</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>

    <span class="n">institutions_map</span> <span class="o">=</span> <span class="n">load_institutions_map</span><span class="p">(</span><span class="n">institutions_json_path</span><span class="p">)</span>

    <span class="n">processed_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing rows&quot;</span><span class="p">):</span>
        <span class="c1"># Remove empty keys from the row</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()}</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Extract unique code and generate API link</span>
        <span class="n">unique_code</span> <span class="o">=</span> <span class="n">extract_unique_code</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">api_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://www.bis.org/api/documents/review/</span><span class="si">{</span><span class="n">unique_code</span><span class="si">}</span><span class="s2">.json&quot;</span>

        <span class="c1"># Fetch document details from the API</span>
        <span class="n">document_details</span> <span class="o">=</span> <span class="n">fetch_document_details</span><span class="p">(</span><span class="n">api_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">document_details</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">institution_number</span> <span class="o">=</span> <span class="n">document_details</span><span class="p">[</span><span class="s2">&quot;institutions&quot;</span><span class="p">]</span>

        <span class="c1"># Handle cases where institution_number is a list</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">institution_number</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">institution_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">institutions_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">institution_number</span><span class="p">]</span>
            <span class="n">institution_name</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">institution_names</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">institution_name</span> <span class="o">=</span> <span class="n">institutions_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">institution_number</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>

        <span class="c1"># Add new data to the row</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;institution_number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">institution_number</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;institution_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">institution_name</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">document_details</span><span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;pdf_file_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">document_details</span><span class="p">[</span><span class="s2">&quot;pdf_file_size&quot;</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;pdf_pages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">document_details</span><span class="p">[</span><span class="s2">&quot;pdf_pages&quot;</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;sources&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">document_details</span><span class="p">[</span><span class="s2">&quot;sources&quot;</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;recurse_category&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">document_details</span><span class="p">[</span><span class="s2">&quot;recurse_category&quot;</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;author_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">document_details</span><span class="p">[</span><span class="s2">&quot;author_id&quot;</span><span class="p">]</span>

        <span class="n">processed_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="c1"># Generate output JSON file name based on input CSV file name</span>
    <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output_json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_processed.json&quot;</span><span class="p">)</span>

    <span class="c1"># Ensure the output directory exists</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Save the processed data as JSON</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_json_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">processed_data</span><span class="p">,</span> <span class="n">json_file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed data saved to </span><span class="si">{</span><span class="n">output_json_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h4>1.4.7 Running the Script</h4>
<p>The script can be run from the command line:</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>bis_processor.py<span class="w"> </span>speeches_2008.csv<span class="w"> </span>--output_dir<span class="w"> </span>Data_BIS/processed/
</code></pre></div>

<hr>
<h3>1.5. Reflections and Lessons Learned</h3>
<h4>1.5.1 Challenges Overcome</h4>
<ul>
<li>
<p>Dynamic Content: Initially, I underestimated the complexity of scraping a JavaScript-heavy site. The discovery of the bulk download page saved significant time and effort.</p>
</li>
<li>
<p>Missing Data: The bulk CSV was incomplete, but the hidden API filled the gaps. This highlights the importance of exploring network requests when dealing with modern websites.</p>
</li>
<li>
<p>Scalability: Downloading and processing thousands of speeches required robust error handling and retry logic. The requests.Session with retries proved invaluable.</p>
</li>
<li>
<p>Data Consistency: Mapping institution numbers to names required a separate lookup file, which I obtained from the BIS website.</p>
</li>
</ul>
<h4>1.5.2 Key Takeaways</h4>
<ul>
<li>
<p>Always look for official data exports before writing a scraper. Many organizations provide bulk downloads.</p>
</li>
<li>
<p>Inspect network traffic to uncover hidden APIs that can simplify data collection.</p>
</li>
<li>
<p>Build resilience into your scripts with retries, timeouts, and informative logging.</p>
</li>
<li>
<p>Use progress bars (like tqdm) for long-running tasks to maintain visibility.</p>
</li>
</ul>
<hr>
<h3>1.6. Conclusion</h3>
<p>This data collection exercise was a valuable lesson in adaptability. By pivoting from a direct scraping approach to a hybrid method (bulk download + API enrichment), I was able to gather a rich dataset efficiently. The final dataset includes over a decade of central bank speeches, ready for the next stages of text preprocessing and analysis.</p>
<p>The complete version of code, along with the rest of our project code, is available in our group’s GitHub repository.</p>
<h2>Step 2 Data preproperssing</h2>
<h3>2.1 Introduction</h3>
<p>The preprocessing phase transforms raw central bank speeches into clean, machine-readable text while calculating corresponding market reactions. This involves text cleaning, tokenization, financial data calculation, and merging to create structured datasets for machine learning.</p>
<h3>2.2 Dependencies and Initialization</h3>
<p>The code begins by importing necessary libraries and initializing NLTK resources for text processing.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">stopwords</span>
<span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="kn">import</span> <span class="n">word_tokenize</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="c1"># Step 0: Initialize NLTK &amp; Core Functions</span>
<span class="c1"># Download NLTK dependencies (only if missing)</span>
<span class="k">def</span> <span class="nf">download_nltk_corpora</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download required NLTK corpora (punkt_tab, stopwords) if not installed&quot;&quot;&quot;</span>
    <span class="n">required_corpora</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;punkt_tab&#39;</span><span class="p">,</span> <span class="s1">&#39;stopwords&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">corpus</span> <span class="ow">in</span> <span class="n">required_corpora</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nltk</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;corpora/</span><span class="si">{</span><span class="n">corpus</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
            <span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">corpus</span><span class="p">)</span>

<span class="n">download_nltk_corpora</span><span class="p">()</span>
</code></pre></div>

<h3>2.3 Text Cleaning Functions</h3>
<h4>2.3.1 Stopwords Configuration</h4>
<p>The get_stopwords function combines NLTK's default English stopwords with financial domain-specific terms to filter low-information content.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Step 0.5: Define stopwords for text cleaning</span>
<span class="k">def</span> <span class="nf">get_stopwords</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Combine NLTK default stopwords + financial speech-specific stopwords&quot;&quot;&quot;</span>
    <span class="n">nltk_stopwords</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">))</span>
    <span class="n">financial_stopwords</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;speech&#39;</span><span class="p">,</span> <span class="s1">&#39;remarks&#39;</span><span class="p">,</span> <span class="s1">&#39;statement&#39;</span><span class="p">,</span> <span class="s1">&#39;thank&#39;</span><span class="p">,</span> <span class="s1">&#39;ladies&#39;</span><span class="p">,</span> <span class="s1">&#39;gentlemen&#39;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">nltk_stopwords</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">financial_stopwords</span><span class="p">)</span>
</code></pre></div>

<h4>2.3.2 Text Cleaning Function</h4>
<p>The clean_text function removes structural noise, normalizes text, and filters stopwords to extract meaningful policy language from messy transcripts.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Step 1 : Text cleaning function (only return cleaned text, no original text)</span>
<span class="k">def</span> <span class="nf">clean_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clean BIS speech text: remove noise, stopwords, and non-meaningful terms</span>
<span class="sd">    Returns only cleaned text (no original text retained)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># 1.1.  Remove table/chart markers, page numbers, URLs/emails</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\|.*?\|+.*?(?:\n|$)&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  <span class="c1"># Remove table structures</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(chart|table)\s+\d+(?:\.\d+)?(?::)?.*?(?:\n|$)&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>  <span class="c1"># Remove chart/table labels</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(page|p)\.?\s+\d+(?:-\d+)?&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>  <span class="c1"># Remove page numbers</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;https?://\S+|www\.\S+|mailto:\S+|\S+@\S+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  <span class="c1"># Remove URLs/emails</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[.*?\]&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  <span class="c1"># Remove [Applause], [Inaudible], etc.</span>

    <span class="c1"># 1.2.  Normalize symbols and remove numbers</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[-—–]+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  <span class="c1"># Normalize dashes/hyphens</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+(?:,\d</span><span class="si">{3}</span><span class="s1">)*\.?\d*%?|%?\d+\.?\d*|[\d.eE+-]+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  <span class="c1"># Remove all numbers/percentages</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\x00-\x7F]+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  <span class="c1"># Remove non-ASCII characters</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^a-zA-Z\s]&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>  <span class="c1"># Retain only letters and spaces</span>

    <span class="c1"># 1.3.  Filter stopwords and short terms</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">stop_words</span> <span class="o">=</span> <span class="n">get_stopwords</span><span class="p">()</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">word_tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">filtered_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stop_words</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">cleaned_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered_words</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">cleaned_text</span>
</code></pre></div>

<h3>2.4 Financial Data Calculation</h3>
<p>The get_financial_future_3m_change function fetches VIX and S&amp;P 500 data and calculates 90-day future percentage changes for market reaction labeling.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#  Step 2: Calculate 3-Month Future Change for VIX/SP500</span>
<span class="k">def</span> <span class="nf">get_financial_future_3m_change</span><span class="p">(</span><span class="n">year</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch daily VIX (^VIX) and SP500 (^GSPC) data for a given year, calculate 3-month (90-day) future percentage change</span>
<span class="sd">    Formula: (Price at t+90 days / Price at t - 1) * 100 (percentage change)</span>
<span class="sd">    Args:</span>
<span class="sd">        year (int): Target year (2008-2019)</span>
<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: Daily data with columns: Date, vix_future_3m_change, sp500_future_3m_change</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define date range: extend to +90 days beyond the year to calculate future changes for Dec dates</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-01-01&quot;</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">-03-31&quot;</span>  <span class="c1"># Ensure enough data for Dec&#39;s 3-month change</span>

    <span class="c1"># Fetch daily data for VIX and SP500</span>
    <span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;^VIX&quot;</span><span class="p">,</span> <span class="s2">&quot;^GSPC&quot;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Download VIX Data</span>
        <span class="n">df_vix</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;^VIX&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;1d&quot;</span><span class="p">)</span>
        <span class="n">df_vix</span> <span class="o">=</span> <span class="n">df_vix</span><span class="p">[[</span><span class="s2">&quot;Close&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Close&quot;</span><span class="p">:</span> <span class="s2">&quot;vix&quot;</span><span class="p">})</span>

        <span class="c1"># Download SP500 Data</span>
        <span class="n">df_sp500</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;^GSPC&quot;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="s2">&quot;1d&quot;</span><span class="p">)</span>
        <span class="n">sp_col</span> <span class="o">=</span> <span class="s2">&quot;Adj Close&quot;</span> <span class="k">if</span> <span class="s2">&quot;Adj Close&quot;</span> <span class="ow">in</span> <span class="n">df_sp500</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="s2">&quot;Close&quot;</span>
        <span class="n">df_sp500</span> <span class="o">=</span> <span class="n">df_sp500</span><span class="p">[[</span><span class="n">sp_col</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">sp_col</span><span class="p">:</span> <span class="s2">&quot;sp500&quot;</span><span class="p">})</span>

        <span class="c1"># Merging</span>
        <span class="n">df_fin</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_vix</span><span class="p">,</span> <span class="n">df_sp500</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span>
        <span class="n">df_fin</span> <span class="o">=</span> <span class="n">df_fin</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>  <span class="c1"># Convert index to Date column</span>
        <span class="n">df_fin</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;vix&quot;</span><span class="p">,</span> <span class="s2">&quot;sp500&quot;</span><span class="p">]</span>  <span class="c1"># Rename columns for clarity</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ fail to download data of（</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">）: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>  

    <span class="c1"># Convert Date to datetime and set as index (for shift calculation)</span>
    <span class="n">df_fin</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_fin</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>
    <span class="n">df_fin</span> <span class="o">=</span> <span class="n">df_fin</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>

    <span class="c1"># Calculate 3-month (90-day) future change (percentage)</span>
    <span class="c1"># shift(-90) = get price 90 days in the future; fillna with NaN for missing future data</span>
    <span class="n">df_fin</span> <span class="o">=</span> <span class="n">df_fin</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">)</span>  
    <span class="n">df_fin</span><span class="p">[</span><span class="s2">&quot;vix_future_3m_change&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_fin</span><span class="p">[</span><span class="s2">&quot;vix&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="o">/</span> <span class="n">df_fin</span><span class="p">[</span><span class="s2">&quot;vix&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">df_fin</span><span class="p">[</span><span class="s2">&quot;sp500_future_3m_change&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_fin</span><span class="p">[</span><span class="s2">&quot;sp500&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="o">/</span> <span class="n">df_fin</span><span class="p">[</span><span class="s2">&quot;sp500&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="c1"># Reset index and filter back to the target year (remove extended dates)</span>
    <span class="n">df_fin</span> <span class="o">=</span> <span class="n">df_fin</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df_fin</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_fin</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
    <span class="n">df_fin</span> <span class="o">=</span> <span class="n">df_fin</span><span class="p">[</span><span class="n">df_fin</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">year</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="s2">&quot;vix&quot;</span><span class="p">,</span> <span class="s2">&quot;sp500&quot;</span><span class="p">])</span>

    <span class="c1"># Round to 2 decimal places for readability</span>
    <span class="n">df_fin</span><span class="p">[[</span><span class="s2">&quot;vix_future_3m_change&quot;</span><span class="p">,</span> <span class="s2">&quot;sp500_future_3m_change&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_fin</span><span class="p">[[</span><span class="s2">&quot;vix_future_3m_change&quot;</span><span class="p">,</span> <span class="s2">&quot;sp500_future_3m_change&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_fin</span>
</code></pre></div>

<h3>2.5 Data Merging Pipeline</h3>
<p>The process_yearly_data function integrates cleaned speech text with financial market data, aligning each speech with corresponding market outcomes.</p>
<div class="highlight"><pre><span></span><code><span class="c1">#  Step 3: Process Yearly Speech + Financial Data </span>
<span class="k">def</span> <span class="nf">process_yearly_data</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">speech_data_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a single year&#39;s speech data + financial data:</span>
<span class="sd">    1. Load yearly speech file (e.g., speeches_2008_processed.json)</span>
<span class="sd">    2. Clean text (only retain cleaned text)</span>
<span class="sd">    3. Match with VIX/SP500 3-month future change by date</span>
<span class="sd">    4. Save as merged_data_YYYY.json</span>
<span class="sd">    Args:</span>
<span class="sd">        year (int): Target year (2008-2019)</span>
<span class="sd">        speech_data_dir (str): Directory containing yearly speech JSON files</span>
<span class="sd">        output_dir (str): Directory to save merged JSON files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 3.1. Load yearly speech file</span>
    <span class="n">speech_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">speech_data_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;speeches_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">_processed.json&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">speech_file</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Skipping </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">: Speech file not found (</span><span class="si">{</span><span class="n">speech_file</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">speech_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">speech_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># Convert to DataFrame and clean</span>
    <span class="n">df_speeches</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">json_normalize</span><span class="p">(</span><span class="n">speech_data</span><span class="p">)</span>

    <span class="c1"># 3.2. Process speech data (date + clean text)</span>
    <span class="n">df_speeches</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_speeches</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
    <span class="c1"># Keep only title/date/text (filter missing values)</span>
    <span class="n">df_speeches</span> <span class="o">=</span> <span class="n">df_speeches</span><span class="p">[[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">])</span>
    <span class="c1"># Clean text (replace original text with cleaned text)</span>
    <span class="n">df_speeches</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_speeches</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">clean_text</span><span class="p">)</span>
    <span class="c1"># Filter empty cleaned text</span>
    <span class="n">df_speeches</span> <span class="o">=</span> <span class="n">df_speeches</span><span class="p">[</span><span class="n">df_speeches</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_speeches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Skipping </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">: No valid cleaned speech data&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># 3.3. Fetch financial data (VIX/SP500 3-month future change)</span>
    <span class="n">df_fin</span> <span class="o">=</span> <span class="n">get_financial_future_3m_change</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df_fin</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Skipping </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">: No valid financial data&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># 3.4. Match speech data with financial data by date (handle non-trading days)</span>
    <span class="c1"># Convert speech dates to date-only (remove time)</span>
    <span class="n">df_speeches</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_speeches</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
    <span class="n">df_fin</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_fin</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>

    <span class="c1"># Merge (left join to retain all speeches; fill NaN for missing financial data)</span>
    <span class="n">df_merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">df_speeches</span><span class="p">,</span>
        <span class="n">df_fin</span><span class="p">,</span>
        <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span>
        <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span>

    <span class="c1"># Rename columns to match your requirement</span>
    <span class="n">df_merged</span> <span class="o">=</span> <span class="n">df_merged</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span>
        <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span>
        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
        <span class="s2">&quot;vix_future_3m_change&quot;</span><span class="p">:</span> <span class="s2">&quot;vix_future_3m_change&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sp500_future_3m_change&quot;</span><span class="p">:</span> <span class="s2">&quot;sp500_future_3m_change&quot;</span>
    <span class="p">})</span>

    <span class="c1"># Convert date back to string (JSON-compatible)</span>
    <span class="n">df_merged</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_merged</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="c1"># Replace NaN with &quot;N/A&quot; for missing financial data (more readable in JSON)</span>
    <span class="n">df_merged</span> <span class="o">=</span> <span class="n">df_merged</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;N/A&quot;</span><span class="p">)</span>

    <span class="c1"># 3.5. Save merged data as JSON</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;merged_data_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
    <span class="n">df_merged</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span>
        <span class="n">output_file</span><span class="p">,</span>
        <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">,</span>
        <span class="n">force_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">indent</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Processed </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_merged</span><span class="p">)</span><span class="si">}</span><span class="s2"> valid speeches saved to </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3>2.6 Main Execution Loop</h3>
<p>The main execution script processes all years from 2008 to 2019 sequentially, creating annual merged datasets.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Step 4: Main Execution (Traverse 2008-2019) </span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Configuration (ADJUST THESE PATHS TO YOUR ENVIRONMENT!)</span>
    <span class="n">SPEECH_DATA_DIR</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;BIS&quot;</span>  <span class="c1"># Directory containing speeches_2008_processed.json, etc.</span>
    <span class="n">OUTPUT_DIR</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;BIS_Merged_Data&quot;</span>  <span class="c1"># Output directory for merged_data_YYYY.json</span>

    <span class="c1"># Traverse 2008 to 2019</span>
    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">2020</span><span class="p">):</span>  <span class="c1"># 2020 is exclusive (stops at 2019)</span>
        <span class="n">process_yearly_data</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">SPEECH_DATA_DIR</span><span class="p">,</span> <span class="n">OUTPUT_DIR</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> All years processed! Check output directory: &quot;</span><span class="p">,</span> <span class="n">OUTPUT_DIR</span><span class="p">)</span>
</code></pre></div>

<h3>2.7 Output Structure</h3>
<p>The preprocessing pipeline generates structured JSON data with five core fields per document, providing clean text paired with market indicators.</p>
<p>{
  "title": "Speech Title",
  "date": "2019-06-15",
  "text": "cleaned text content here",
  "vix_future_3m_change": 12.34,
  "sp500_future_3m_change": -5.67
}</p>
<h2>Step 3  Dictionary</h2>
<h3>3.1 Introduction</h3>
<p>In dictionary construction, in addition to using the AFINN predefined sentiment dictionary as an external reference, we further build a custom dictionary entirely derived from the sample data itself.</p>
<p>The motivation for this approach is that general-purpose sentiment dictionaries are not designed specifically for financial contexts or for particular text sources. As a result, their sentiment labels may not accurately reflect the market-relevant meaning of words in our setting.</p>
<p>Therefore, we adopt a data-driven approach, allowing a word’s “sentiment” or market meaning to be determined directly by the historical market outcomes associated with its occurrences, rather than by ex ante human annotation.</p>
<p>The central idea of the custom dictionary can be summarized as follows:</p>
<ul>
<li>
<p>If a word tends to be followed by relatively consistent market reactions after it appears in texts, then that word can be regarded as carrying a specific market meaning.</p>
</li>
<li>
<p>Unlike traditional sentiment dictionaries, the “meaning” here does not refer simply to positive or negative emotion. Instead, it refers to statistical characteristics related to future market behavior, such as:</p>
</li>
<li>
<p>Whether the word is more frequently associated with future market increases or declines</p>
</li>
<li>
<p>Whether it is related to rising or falling volatility</p>
</li>
<li>
<p>Whether it tends to appear only during extreme market conditions</p>
</li>
</ul>
<h3>3.2 Building Dictionary</h3>
<h4>Step 1: Constructing Future-Looking Market Labels</h4>
<p>To ensure that dictionary construction does not confound the causal ordering, we first construct future-looking market change indicators for each date, measuring market performance after the text appears—specifically over the next three months (approximately 63 trading days).</p>
<p>Concretely, we compute:</p>
<ul>
<li>
<p>The three-month forward return of the S&amp;P 500</p>
</li>
<li>
<p>The three-month forward change of the VIX</p>
</li>
</ul>
<p>This design ensures that all statistical properties assigned to each word are based on post-occurrence market outcomes, rather than contemporaneous or backward-looking information. These labels are constructed using the dataset established earlier.</p>
<h4>Step 2: Building the “Word–Date–Market Outcome” Mapping</h4>
<p>In text processing, we adopt unigrams (individual words) as the most basic and robust analytical unit.
Each document is first tokenized into a list of unigrams and then converted into a set of unique words, preventing multiple counts of the same word within a single document.</p>
<p>As we iterate through the documents, we record three core pieces of information for each word:</p>
<p>The set of distinct dates on which the word appears</p>
<p>The corresponding future S&amp;P 500 change for each date</p>
<p>The corresponding future VIX change for each date</p>
<p>Importantly, we use “word × date” as the minimal counting unit, rather than raw word frequency. The implicit assumption is that:</p>
<p>What matters is whether a word appears on a given day, not how many times it appears.</p>
<p>This treatment effectively mitigates distortions caused by differences in document length or excessive repetition of high-frequency words, leading to a more stable and interpretable dictionary construction.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">calculate_future_changes</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">63</span><span class="p">):</span>
    <span class="n">future_values</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">days</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">future_values</span> <span class="o">-</span> <span class="n">series</span><span class="p">)</span> <span class="o">/</span> <span class="n">series</span>


<span class="n">df_market</span><span class="p">[</span><span class="s1">&#39;sp500_change_3m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_future_changes</span><span class="p">(</span><span class="n">df_market</span><span class="p">[</span><span class="s1">&#39;sp500_close&#39;</span><span class="p">],</span> <span class="mi">63</span><span class="p">)</span>
<span class="n">df_market</span><span class="p">[</span><span class="s1">&#39;vix_change_3m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_future_changes</span><span class="p">(</span><span class="n">df_market</span><span class="p">[</span><span class="s1">&#39;vix_close&#39;</span><span class="p">],</span> <span class="mi">63</span><span class="p">)</span>


<span class="n">word_market_changes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span>
    <span class="s1">&#39;dates&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>  
    <span class="s1">&#39;sp500_changes&#39;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s1">&#39;vix_changes&#39;</span><span class="p">:</span> <span class="p">{}</span>
<span class="p">})</span>


<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">idx</span>  

    <span class="n">unigrams</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;unigrams&#39;</span><span class="p">]</span>


    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">):</span>
        <span class="n">date_key</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="n">date_key</span> <span class="o">=</span> <span class="n">date</span>

    <span class="k">if</span> <span class="n">date_key</span> <span class="ow">in</span> <span class="n">df_market</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">sp500_change</span> <span class="o">=</span> <span class="n">df_market</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date_key</span><span class="p">,</span> <span class="s1">&#39;sp500_change_3m&#39;</span><span class="p">]</span>
        <span class="n">vix_change</span> <span class="o">=</span> <span class="n">df_market</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date_key</span><span class="p">,</span> <span class="s1">&#39;vix_change_3m&#39;</span><span class="p">]</span>


        <span class="n">unique_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">unigrams</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">unique_words</span><span class="p">:</span>
            <span class="n">word_market_changes</span><span class="p">[</span><span class="n">word</span><span class="p">][</span><span class="s1">&#39;dates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">date_key</span><span class="p">)</span>
            <span class="n">word_market_changes</span><span class="p">[</span><span class="n">word</span><span class="p">][</span><span class="s1">&#39;sp500_changes&#39;</span><span class="p">][</span><span class="n">date_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp500_change</span>
            <span class="n">word_market_changes</span><span class="p">[</span><span class="n">word</span><span class="p">][</span><span class="s1">&#39;vix_changes&#39;</span><span class="p">][</span><span class="n">date_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vix_change</span>

<span class="n">word_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">changes</span> <span class="ow">in</span> <span class="n">word_market_changes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;dates&#39;</span><span class="p">]:</span>  
        <span class="n">dates_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="s1">&#39;dates&#39;</span><span class="p">])</span>
        <span class="n">sp500_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">changes</span><span class="p">[</span><span class="s1">&#39;sp500_changes&#39;</span><span class="p">][</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dates_list</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="s1">&#39;sp500_changes&#39;</span><span class="p">][</span><span class="n">d</span><span class="p">])]</span>
        <span class="n">vix_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">changes</span><span class="p">[</span><span class="s1">&#39;vix_changes&#39;</span><span class="p">][</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dates_list</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="s1">&#39;vix_changes&#39;</span><span class="p">][</span><span class="n">d</span><span class="p">])]</span>

        <span class="n">word_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;word&#39;</span><span class="p">:</span> <span class="n">word</span><span class="p">,</span>
            <span class="s1">&#39;dates&#39;</span><span class="p">:</span> <span class="n">dates_list</span><span class="p">,</span>
            <span class="s1">&#39;sp500_changes&#39;</span><span class="p">:</span> <span class="n">sp500_values</span><span class="p">,</span>
            <span class="s1">&#39;vix_changes&#39;</span><span class="p">:</span> <span class="n">vix_values</span><span class="p">,</span>
            <span class="s1">&#39;unique_dates_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates_list</span><span class="p">),</span> 
            <span class="s1">&#39;avg_sp500_change&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sp500_values</span><span class="p">)</span> <span class="k">if</span> <span class="n">sp500_values</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;avg_vix_change&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vix_values</span><span class="p">)</span> <span class="k">if</span> <span class="n">vix_values</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">})</span>

<span class="n">df_word_market</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">word_data</span><span class="p">)</span>

<span class="n">df_word_market</span> <span class="o">=</span> <span class="n">df_word_market</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;unique_dates_count&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

<h4>Step 3: Constructing an “Extended Dictionary” with Robustification</h4>
<p>In further analysis, we recognize that simple averages are highly sensitive to noise and extreme values. Therefore, in the extended version, we introduce multiple robust statistical dimensions into the custom dictionary, transforming it from a single-number representation into a multi-metric structure.</p>
<p>Specifically, the extensions include:</p>
<p>(1) Directional information (binarization)
Future market changes are converted into directional indicators (up / down), emphasizing the consistency between a word’s occurrence and subsequent market direction.</p>
<p>(2) Threshold filtering
Market movements are included in the statistics only when they exceed predefined thresholds, allowing the analysis to focus on economically meaningful fluctuations.</p>
<p>(3) Joint indicators (S&amp;P 500 + VIX)
By jointly incorporating equity index and volatility information, we capture a word’s association with the overall market state, rather than with a single market dimension.</p>
<p>(4) Frequency thresholds
Statistical results are retained only for words that appear on a sufficient number of distinct dates, reducing the risk of spurious correlations driven by low-frequency words.</p>
<p>Through these procedures, we ultimately construct a hierarchical and adaptive dictionary system, in which each word is characterized not only by whether it is relevant, but also by under what conditions it is relevant.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Compute future market changes over a specified horizon (default: 3 months ≈ 63 trading days)</span>
<span class="k">def</span> <span class="nf">calculate_future_changes</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">63</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute percentage change over a future window&quot;&quot;&quot;</span>
    <span class="n">future_values</span> <span class="o">=</span> <span class="n">series</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">days</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">future_values</span> <span class="o">-</span> <span class="n">series</span><span class="p">)</span> <span class="o">/</span> <span class="n">series</span>

<span class="c1"># Compute 3-month forward changes for S&amp;P 500 and VIX</span>
<span class="n">df_market</span><span class="p">[</span><span class="s1">&#39;sp500_change_3m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_future_changes</span><span class="p">(</span><span class="n">df_market</span><span class="p">[</span><span class="s1">&#39;sp500_close&#39;</span><span class="p">],</span> <span class="mi">63</span><span class="p">)</span>
<span class="n">df_market</span><span class="p">[</span><span class="s1">&#39;vix_change_3m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_future_changes</span><span class="p">(</span><span class="n">df_market</span><span class="p">[</span><span class="s1">&#39;vix_close&#39;</span><span class="p">],</span> <span class="mi">63</span><span class="p">)</span>

<span class="c1"># Create a mapping from words to future market changes</span>
<span class="n">word_market_changes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span>
    <span class="s1">&#39;dates&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>              <span class="c1"># Use a set instead of a list to automatically remove duplicates</span>
    <span class="s1">&#39;sp500_changes&#39;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s1">&#39;vix_changes&#39;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s1">&#39;sp500_binary&#39;</span><span class="p">:</span> <span class="p">{},</span>          <span class="c1"># New: binarized S&amp;P 500 changes</span>
    <span class="s1">&#39;vix_binary&#39;</span><span class="p">:</span> <span class="p">{},</span>            <span class="c1"># New: binarized VIX changes</span>
<span class="p">})</span>

<span class="c1"># Threshold parameters</span>
<span class="n">sp500_threshold</span> <span class="o">=</span> <span class="mf">0.03</span>           <span class="c1"># 3% threshold (adjustable)</span>
<span class="n">vix_threshold</span> <span class="o">=</span> <span class="mf">0.10</span>             <span class="c1"># 10% threshold (adjustable)</span>
<span class="n">frequency_threshold</span> <span class="o">=</span> <span class="mi">10</span>         <span class="c1"># Minimum word frequency threshold (adjustable)</span>

<span class="c1"># Iterate through each document — date is the index</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">idx</span>                   <span class="c1"># Date is stored in the index, not a column</span>
    <span class="n">unigrams</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;unigrams&#39;</span><span class="p">]</span>

    <span class="c1"># Ensure date format matches df_market index</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">):</span>
        <span class="n">date_key</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>   <span class="c1"># Convert to date object</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">date_key</span> <span class="o">=</span> <span class="n">date</span>

    <span class="c1"># Check whether market data exists for this date</span>
    <span class="k">if</span> <span class="n">date_key</span> <span class="ow">in</span> <span class="n">df_market</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">sp500_change</span> <span class="o">=</span> <span class="n">df_market</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date_key</span><span class="p">,</span> <span class="s1">&#39;sp500_change_3m&#39;</span><span class="p">]</span>
        <span class="n">vix_change</span> <span class="o">=</span> <span class="n">df_market</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">date_key</span><span class="p">,</span> <span class="s1">&#39;vix_change_3m&#39;</span><span class="p">]</span>

        <span class="c1"># Extract unique words from the document (deduplicated)</span>
        <span class="n">unique_words</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">unigrams</span><span class="p">)</span>

        <span class="c1"># Record market changes for each unique word in the document</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">unique_words</span><span class="p">:</span>
            <span class="n">word_market_changes</span><span class="p">[</span><span class="n">word</span><span class="p">][</span><span class="s1">&#39;dates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">date_key</span><span class="p">)</span>
            <span class="n">word_market_changes</span><span class="p">[</span><span class="n">word</span><span class="p">][</span><span class="s1">&#39;sp500_changes&#39;</span><span class="p">][</span><span class="n">date_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp500_change</span>
            <span class="n">word_market_changes</span><span class="p">[</span><span class="n">word</span><span class="p">][</span><span class="s1">&#39;vix_changes&#39;</span><span class="p">][</span><span class="n">date_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vix_change</span>

            <span class="c1"># 1. Binarize changes (-1, 0, +1)</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">sp500_change</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sp500_change</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">word_market_changes</span><span class="p">[</span><span class="n">word</span><span class="p">][</span><span class="s1">&#39;sp500_binary&#39;</span><span class="p">][</span><span class="n">date_key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">sp500_change</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">word_market_changes</span><span class="p">[</span><span class="n">word</span><span class="p">][</span><span class="s1">&#39;sp500_binary&#39;</span><span class="p">][</span><span class="n">date_key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">word_market_changes</span><span class="p">[</span><span class="n">word</span><span class="p">][</span><span class="s1">&#39;sp500_binary&#39;</span><span class="p">][</span><span class="n">date_key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">vix_change</span><span class="p">):</span>
                <span class="c1"># VIX is typically inversely related to equity markets</span>
                <span class="k">if</span> <span class="n">vix_change</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">word_market_changes</span><span class="p">[</span><span class="n">word</span><span class="p">][</span><span class="s1">&#39;vix_binary&#39;</span><span class="p">][</span><span class="n">date_key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>   <span class="c1"># Rising VIX usually implies market stress</span>
                <span class="k">elif</span> <span class="n">vix_change</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">word_market_changes</span><span class="p">[</span><span class="n">word</span><span class="p">][</span><span class="s1">&#39;vix_binary&#39;</span><span class="p">][</span><span class="n">date_key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Falling VIX usually implies market recovery</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">word_market_changes</span><span class="p">[</span><span class="n">word</span><span class="p">][</span><span class="s1">&#39;vix_binary&#39;</span><span class="p">][</span><span class="n">date_key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># Convert aggregated results to DataFrame</span>
<span class="n">word_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">changes</span> <span class="ow">in</span> <span class="n">word_market_changes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;dates&#39;</span><span class="p">]:</span>  <span class="c1"># Keep only words with valid observations</span>
        <span class="c1"># Convert date set to list for computation</span>
        <span class="n">dates_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="s1">&#39;dates&#39;</span><span class="p">])</span>

        <span class="c1"># Base continuous values</span>
        <span class="n">sp500_values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;sp500_changes&#39;</span><span class="p">][</span><span class="n">d</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dates_list</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="s1">&#39;sp500_changes&#39;</span><span class="p">][</span><span class="n">d</span><span class="p">])</span>
        <span class="p">]</span>
        <span class="n">vix_values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;vix_changes&#39;</span><span class="p">][</span><span class="n">d</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dates_list</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="s1">&#39;vix_changes&#39;</span><span class="p">][</span><span class="n">d</span><span class="p">])</span>
        <span class="p">]</span>

        <span class="c1"># 1. Binarized averages</span>
        <span class="n">sp500_binary_vals</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;sp500_binary&#39;</span><span class="p">][</span><span class="n">d</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dates_list</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;sp500_binary&#39;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">vix_binary_vals</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;vix_binary&#39;</span><span class="p">][</span><span class="n">d</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dates_list</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;vix_binary&#39;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="c1"># 2. Threshold-filtered averages</span>
        <span class="n">sp500_values_thresh</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sp500_values</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sp500_threshold</span><span class="p">]</span>
        <span class="n">vix_values_thresh</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vix_values</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">vix_threshold</span><span class="p">]</span>

        <span class="c1"># 3. Joint scores (when both S&amp;P 500 and VIX exhibit abnormal behavior)</span>
        <span class="n">joint_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">joint_division_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dates_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;sp500_changes&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;vix_changes&#39;</span><span class="p">]:</span>
                <span class="n">sp_val</span> <span class="o">=</span> <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;sp500_changes&#39;</span><span class="p">][</span><span class="n">d</span><span class="p">]</span>
                <span class="n">vix_val</span> <span class="o">=</span> <span class="n">changes</span><span class="p">[</span><span class="s1">&#39;vix_changes&#39;</span><span class="p">][</span><span class="n">d</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">sp_val</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">vix_val</span><span class="p">):</span>
                    <span class="c1"># Sum-based joint score (VIX sign reversed)</span>
                    <span class="n">joint_sum</span> <span class="o">=</span> <span class="n">sp_val</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">vix_val</span><span class="p">)</span>
                    <span class="n">joint_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joint_sum</span><span class="p">)</span>

                    <span class="c1"># Ratio-based joint score (avoid division by zero)</span>
                    <span class="k">if</span> <span class="n">vix_val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">joint_div</span> <span class="o">=</span> <span class="n">sp_val</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vix_val</span><span class="p">)</span>
                        <span class="n">joint_division_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joint_div</span><span class="p">)</span>

        <span class="c1"># 4. Frequency-threshold-adjusted averages</span>
        <span class="c1"># Compute word frequency (number of unique dates)</span>
        <span class="n">word_frequency</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates_list</span><span class="p">)</span>

        <span class="c1"># Base averages</span>
        <span class="n">avg_sp500</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sp500_values</span><span class="p">)</span> <span class="k">if</span> <span class="n">sp500_values</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">avg_vix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vix_values</span><span class="p">)</span> <span class="k">if</span> <span class="n">vix_values</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># Use averages only if frequency exceeds the threshold</span>
        <span class="n">avg_sp500_freq_thresh</span> <span class="o">=</span> <span class="n">avg_sp500</span> <span class="k">if</span> <span class="n">word_frequency</span> <span class="o">&gt;=</span> <span class="n">frequency_threshold</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">avg_vix_freq_thresh</span> <span class="o">=</span> <span class="n">avg_vix</span> <span class="k">if</span> <span class="n">word_frequency</span> <span class="o">&gt;=</span> <span class="n">frequency_threshold</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">word_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;word&#39;</span><span class="p">:</span> <span class="n">word</span><span class="p">,</span>
            <span class="s1">&#39;dates&#39;</span><span class="p">:</span> <span class="n">dates_list</span><span class="p">,</span>
            <span class="s1">&#39;sp500_changes&#39;</span><span class="p">:</span> <span class="n">sp500_values</span><span class="p">,</span>
            <span class="s1">&#39;vix_changes&#39;</span><span class="p">:</span> <span class="n">vix_values</span><span class="p">,</span>
            <span class="s1">&#39;unique_dates_count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates_list</span><span class="p">),</span>  <span class="c1"># Number of distinct dates the word appears</span>

            <span class="c1"># Base averages</span>
            <span class="s1">&#39;avg_sp500_change&#39;</span><span class="p">:</span> <span class="n">avg_sp500</span><span class="p">,</span>
            <span class="s1">&#39;avg_vix_change&#39;</span><span class="p">:</span> <span class="n">avg_vix</span><span class="p">,</span>

            <span class="c1"># 1. Binarized variables</span>
            <span class="s1">&#39;avg_sp500_binary&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sp500_binary_vals</span><span class="p">)</span> <span class="k">if</span> <span class="n">sp500_binary_vals</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;avg_vix_binary&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vix_binary_vals</span><span class="p">)</span> <span class="k">if</span> <span class="n">vix_binary_vals</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>

            <span class="c1"># 2. Threshold-filtered averages</span>
            <span class="s1">&#39;avg_sp500_threshold&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sp500_values_thresh</span><span class="p">)</span> <span class="k">if</span> <span class="n">sp500_values_thresh</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;avg_vix_threshold&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vix_values_thresh</span><span class="p">)</span> <span class="k">if</span> <span class="n">vix_values_thresh</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;count_sp500_threshold&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp500_values_thresh</span><span class="p">),</span>  <span class="c1"># Observations exceeding threshold</span>
            <span class="s1">&#39;count_vix_threshold&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">vix_values_thresh</span><span class="p">),</span>

            <span class="c1"># 3. Joint scores</span>
            <span class="s1">&#39;avg_joint_sum&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">joint_scores</span><span class="p">)</span> <span class="k">if</span> <span class="n">joint_scores</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;avg_joint_division&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">joint_division_scores</span><span class="p">)</span> <span class="k">if</span> <span class="n">joint_division_scores</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;joint_observations&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">joint_scores</span><span class="p">),</span>  <span class="c1"># Number of joint observations</span>

            <span class="c1"># 4. Frequency-threshold-adjusted averages</span>
            <span class="s1">&#39;avg_sp500_freq_thresh&#39;</span><span class="p">:</span> <span class="n">avg_sp500_freq_thresh</span><span class="p">,</span>
            <span class="s1">&#39;avg_vix_freq_thresh&#39;</span><span class="p">:</span> <span class="n">avg_vix_freq_thresh</span><span class="p">,</span>
            <span class="s1">&#39;meets_frequency_threshold&#39;</span><span class="p">:</span> <span class="n">word_frequency</span> <span class="o">&gt;=</span> <span class="n">frequency_threshold</span><span class="p">,</span>
        <span class="p">})</span>

<span class="n">df_word_market</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">word_data</span><span class="p">)</span>

<span class="c1"># Sort by the number of unique dates (descending)</span>
<span class="n">df_word_market</span> <span class="o">=</span> <span class="n">df_word_market</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;unique_dates_count&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

<h4>Step 4: Mapping the AFINN Dictionary to the Sample Vocabulary Space</h4>
<p>In implementation, we first map the AFINN sentiment scores onto the set of words that actually appear in our sample.
For each word, if it exists in the AFINN dictionary, it is assigned the corresponding sentiment score; otherwise, its score is set to zero.</p>
<p><code>python
 df_word_market = df_word_market.assign(
    afinn_score=df_word_market['word'].map(
        lambda x: afinn.loc[afinn['word'] == x, 'score'].values[0] 
        if x in afinn['word'].values else 0
    )
)</code></p>
<h4>Step 5 From Word-Level Dictionaries to Document-Level Scores</h4>
<p>After constructing the dictionaries, we face a practical question:
how should word-level information be aggregated to the document level, so that it can be aligned with market variables or other units of analysis?</p>
<p>To address this, we adopt a simple and interpretable aggregation scheme.
For each document, we compute the average score of all words appearing in the text.</p>
<p>Specifically, for each dictionary dimension (including AFINN scores, custom market-based scores, and others), we calculate:</p>
<ul>
<li>
<p>The mean score of all words appearing in the document</p>
</li>
<li>
<p>Words that do not exist in a given dictionary are assigned a score of zero</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># 1. Ensure df_clean has the correct columns</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Columns in df_clean:&quot;</span><span class="p">,</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Index name of df_clean:&quot;</span><span class="p">,</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="c1"># 2. If the date is stored in the index, convert it to a column</span>
<span class="k">if</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;date&#39;</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_clean</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">):</span>
    <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Date index has been converted to a column&quot;</span><span class="p">)</span>

<span class="c1"># 3. Check whether a &#39;date&#39; column exists</span>
<span class="k">if</span> <span class="s1">&#39;date&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="c1"># Try to find alternative column names that may represent dates</span>
    <span class="n">date_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;date&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;time&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">date_cols</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Potential date column(s) found: </span><span class="si">{</span><span class="n">date_cols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Rename the first candidate to &#39;date&#39;</span>
        <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">date_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="s1">&#39;date&#39;</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If no date column is found, create one using the index</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No date column found, using index as date&quot;</span><span class="p">)</span>
        <span class="n">df_clean</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">index</span>

<span class="c1"># 4. Select numeric score columns only</span>
<span class="n">numeric_score_columns</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_word_market</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">,</span> <span class="s1">&#39;dates&#39;</span><span class="p">,</span> <span class="s1">&#39;unique_dates_count&#39;</span><span class="p">]:</span>
        <span class="k">continue</span>

    <span class="c1"># Check data type</span>
    <span class="k">if</span> <span class="n">df_word_market</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">]:</span>
        <span class="n">numeric_score_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Attempt type conversion</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df_word_market</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df_word_market</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
            <span class="n">numeric_score_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: cannot be converted to numeric&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">numeric_score_columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> numeric score columns&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Score columns:&quot;</span><span class="p">,</span> <span class="n">numeric_score_columns</span><span class="p">)</span>

<span class="c1"># 5. Create dictionaries using numeric score columns only</span>
<span class="n">word_score_dicts</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_score_columns</span><span class="p">:</span>
    <span class="n">word_score_dicts</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span>
            <span class="n">df_word_market</span><span class="p">[</span><span class="s1">&#39;word&#39;</span><span class="p">],</span>
            <span class="n">df_word_market</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

<span class="c1"># 6. Simplified document-level score calculation function</span>
<span class="k">def</span> <span class="nf">calculate_document_scores_simple</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">word_score_dicts</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute mean scores for a single document&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_mean&quot;</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">word_score_dicts</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

    <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_mean&quot;</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">word_score_dicts</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">score_dict</span> <span class="ow">in</span> <span class="n">word_score_dicts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">score_dict</span><span class="p">:</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score_dict</span><span class="p">[</span><span class="n">word</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">scores</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># 7. Compute document scores</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting document score computation...&quot;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="c1"># Safely extract fields</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># Calculate document scores</span>
    <span class="n">doc_scores</span> <span class="o">=</span> <span class="n">calculate_document_scores_simple</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">word_score_dicts</span><span class="p">)</span>

    <span class="c1"># Construct result row</span>
    <span class="n">result_row</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
        <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)[:</span><span class="mi">300</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">300</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># Append computed scores</span>
    <span class="n">result_row</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">doc_scores</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_row</span><span class="p">)</span>

    <span class="c1"># Progress update</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> documents&quot;</span><span class="p">)</span>

<span class="c1"># 8. Convert results to DataFrame</span>
<span class="n">df_document_scores</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># 9. Reorder columns</span>
<span class="n">base_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">]</span>
<span class="n">other_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_document_scores</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_columns</span><span class="p">]</span>

<span class="c1"># Sort by importance</span>
<span class="k">if</span> <span class="s1">&#39;avg_sp500_change_mean&#39;</span> <span class="ow">in</span> <span class="n">other_columns</span><span class="p">:</span>
    <span class="n">other_columns</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;avg_sp500_change_mean&#39;</span><span class="p">)</span>
    <span class="n">other_columns</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;avg_sp500_change_mean&#39;</span><span class="p">)</span>

<span class="c1"># Move other important columns to the front</span>
<span class="n">important_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;avg_vix_change_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;avg_sp500_binary_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;afinn_score_mean&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">important_cols</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">other_columns</span><span class="p">:</span>
        <span class="n">other_columns</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">other_columns</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>

<span class="n">final_columns</span> <span class="o">=</span> <span class="n">base_columns</span> <span class="o">+</span> <span class="n">other_columns</span>
<span class="n">df_document_scores</span> <span class="o">=</span> <span class="n">df_document_scores</span><span class="p">[</span><span class="n">final_columns</span><span class="p">]</span>

<span class="n">df_document_scores</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>

<h2>4. Modeling: XGBOOST</h2>
<h3>4.1. Motivation and Problem Setup</h3>
<p>After transforming our speeches into document-level scores (Step 3), the next question was straightforward but important:</p>
<p>Do these text-derived signals contain predictive information about future market stress?</p>
<p>To make the evaluation concrete, we framed this as a binary classification task. Our target variable is:</p>
<p>sp500_drop_8pct_next_3m: whether the S&amp;P 500 experiences a drop of at least 8% within the next three months.</p>
<p>This definition aligns with our project goal of moving “from words to warning signals”. Instead of predicting small fluctuations, we focus on tail-risk style drawdowns that are economically meaningful.</p>
<h3>4.2. Time-Based Train–Test Split (Avoiding Look-Ahead Bias)</h3>
<p>A key modeling decision was to split the dataset by time, rather than randomly. In finance, random splitting can easily introduce look-ahead bias and inflate performance because the model may implicitly learn future patterns.</p>
<p>We therefore use:</p>
<ul>
<li>
<p>Training set: 2008–2014</p>
</li>
<li>
<p>Test set: 2015–2019</p>
</li>
</ul>
<p>This mimics a realistic deployment setting: the model learns from past speeches and is evaluated on a later period it has never seen.</p>
<p>To ensure the split is valid, we first check:</p>
<ul>
<li>
<p>the date range</p>
</li>
<li>
<p>the number of speeches per year</p>
</li>
<li>
<p>the positive class proportion per year (crucial for crash prediction tasks)</p>
</li>
</ul>
<p>This step also helped us detect potential issues early (e.g., missing years or extremely imbalanced periods).</p>
<h3>4.3. Feature Construction: Combining Dictionary Scores and TF–IDF</h3>
<p>Our features come from two sources:</p>
<p>(1) Numeric features: dictionary-based document scores</p>
<p>These are the outputs from Step 3, including:</p>
<ul>
<li>
<p>custom market-based scores (e.g., avg_sp500_change_mean, avg_vix_change_mean)</p>
</li>
<li>
<p>robustified variants (binary / threshold / joint scores, if included)</p>
</li>
<li>
<p>AFINN-based sentiment signal (afinn_score_mean)</p>
</li>
</ul>
<p>This set preserves interpretability: each feature corresponds to a clear “text → market” mapping mechanism.</p>
<p>(2) Text features: TF–IDF (lightweight baseline)</p>
<p>In addition, we add a small TF–IDF representation of (text + title):</p>
<p>max_features = 50 (to control dimensionality)</p>
<p>min_df = 2 (to reduce extreme sparsity)</p>
<p>stop_words = 'english'</p>
<p>We treat TF–IDF as a sanity check: if a simple bag-of-words representation adds incremental predictive power beyond our dictionary signals, that suggests our dictionary is capturing only part of the information.</p>
<p>Importantly, the TF–IDF vectorizer is fit on the training set only, then applied to the test set, to avoid leakage.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">classification_report</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span>
    <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">precision_score</span><span class="p">,</span> <span class="n">recall_score</span><span class="p">,</span> <span class="n">f1_score</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">TfidfVectorizer</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">joblib</span>

<span class="c1"># Assume df_document_scores is your existing DataFrame</span>
<span class="c1"># Check basic data information</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Basic Data Information:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset shape: </span><span class="si">{</span><span class="n">df_document_scores</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column names: </span><span class="si">{</span><span class="n">df_document_scores</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 1. Data Preprocessing</span>
<span class="c1"># Ensure the date column is in datetime format</span>
<span class="n">df_document_scores</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_document_scores</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

<span class="c1"># Check date range</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data Date Range: </span><span class="si">{</span><span class="n">df_document_scores</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">df_document_scores</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Extract year from date</span>
<span class="n">df_document_scores</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_document_scores</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>

<span class="c1"># Inspect data distribution by year</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Data Distribution by Year:&quot;</span><span class="p">)</span>
<span class="n">year_counts</span> <span class="o">=</span> <span class="n">df_document_scores</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">year_counts</span><span class="p">)</span>

<span class="c1"># Check whether data exists for 2008–2014 (training) and 2015–2019 (testing)</span>
<span class="n">required_train_years</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">2015</span><span class="p">))</span>
<span class="n">required_test_years</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">2020</span><span class="p">))</span>

<span class="n">train_years_present</span> <span class="o">=</span> <span class="p">[</span><span class="n">year</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">required_train_years</span> <span class="k">if</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">df_document_scores</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
<span class="n">test_years_present</span> <span class="o">=</span> <span class="p">[</span><span class="n">year</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">required_test_years</span> <span class="k">if</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">df_document_scores</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Train years present (2008-2014): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_years_present</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">required_train_years</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test years present (2015-2019): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_years_present</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">required_test_years</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Handle missing values</span>
<span class="n">df_cleaned</span> <span class="o">=</span> <span class="n">df_document_scores</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># For numeric features, fill missing values with the median (robust for financial data)</span>
<span class="n">numeric_cols</span> <span class="o">=</span> <span class="n">df_cleaned</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_cols</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span>  <span class="c1"># Exclude year column</span>
        <span class="n">df_cleaned</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cleaned</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df_cleaned</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>

<span class="c1"># For text columns, fill missing values with empty strings</span>
<span class="n">text_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">text_cols</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_cleaned</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df_cleaned</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cleaned</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="c1"># 2. Time-based Train-Test Split</span>
<span class="c1"># Training set: 2008–2014</span>
<span class="c1"># Test set: 2015–2019</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">df_cleaned</span><span class="p">[</span><span class="n">df_cleaned</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">2014</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">df_cleaned</span><span class="p">[</span><span class="n">df_cleaned</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">2019</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training set (2008-2014) size: </span><span class="si">{</span><span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test set (2015-2019) size: </span><span class="si">{</span><span class="n">test_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Training set (2008-2014) is empty, cannot train model!&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Test set (2015-2019) is empty, cannot evaluate model!&quot;</span><span class="p">)</span>

<span class="c1"># Check year distribution in training and test sets</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training set year distribution:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Test set year distribution:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">())</span>

<span class="c1"># 3. Feature Engineering</span>
<span class="c1"># Select numeric features (excluding target, date, and year)</span>
<span class="n">exclude_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;sp500_drop_8pct_next_3m&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">]</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_cleaned</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_cols</span> <span class="ow">and</span> <span class="n">df_cleaned</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
<span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Number of numeric features used: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">numeric_features</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Numeric features:&quot;</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">)</span>

<span class="c1"># Create text-based features if text data is available</span>
<span class="k">if</span> <span class="s1">&#39;text&#39;</span> <span class="ow">in</span> <span class="n">df_cleaned</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">df_cleaned</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Creating text features...&quot;</span><span class="p">)</span>
    <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">max_features</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">stop_words</span><span class="o">=</span><span class="s1">&#39;english&#39;</span><span class="p">,</span> <span class="n">min_df</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Training text</span>
    <span class="n">train_text</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">train_text_features</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">train_text</span><span class="p">)</span>
    <span class="n">train_text_features_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">train_text_features</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;tfidf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">train_text_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="p">)</span>

    <span class="c1"># Test text</span>
    <span class="n">test_text</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">test_text_features</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_text</span><span class="p">)</span>
    <span class="n">test_text_features_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">test_text_features</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;tfidf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">test_text_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="p">)</span>

    <span class="c1"># Combine numeric and text features</span>
    <span class="n">X_train_numeric</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="n">numeric_features</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_train_numeric</span><span class="p">,</span> <span class="n">train_text_features_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">X_test_numeric</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">numeric_features</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_test_numeric</span><span class="p">,</span> <span class="n">test_text_features_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Use numeric features only</span>
    <span class="n">X_train</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="n">numeric_features</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="n">numeric_features</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Target variable</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="s1">&#39;sp500_drop_8pct_next_3m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">test_data</span><span class="p">[</span><span class="s1">&#39;sp500_drop_8pct_next_3m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training features shape: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test features shape: </span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training target shape: </span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test target shape: </span><span class="si">{</span><span class="n">y_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Check class distribution</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training positive class proportion: </span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test positive class proportion: </span><span class="si">{</span><span class="n">y_test</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">y_test</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="c1"># Check positive class proportion by year</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training set positive class proportion by year:&quot;</span><span class="p">)</span>
<span class="n">train_year_stats</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)[</span><span class="s1">&#39;sp500_drop_8pct_next_3m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">train_year_stats</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">train_year_stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">year</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Test set positive class proportion by year:&quot;</span><span class="p">)</span>
<span class="n">test_year_stats</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)[</span><span class="s1">&#39;sp500_drop_8pct_next_3m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">test_year_stats</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">test_year_stats</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">year</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="c1"># 4. Feature Standardization</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># 5. Handle Class Imbalance</span>
<span class="n">positive_count</span> <span class="o">=</span> <span class="n">y_train</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">negative_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span> <span class="o">-</span> <span class="n">positive_count</span>
<span class="n">scale_pos_weight</span> <span class="o">=</span> <span class="n">negative_count</span> <span class="o">/</span> <span class="n">positive_count</span> <span class="k">if</span> <span class="n">positive_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Class imbalance handling - scale_pos_weight: </span><span class="si">{</span><span class="n">scale_pos_weight</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 6. Train XGBoost Model</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training XGBoost model...&quot;</span><span class="p">)</span>
<span class="n">xgb_model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">subsample</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">colsample_bytree</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">,</span>
    <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">scale_pos_weight</span><span class="o">=</span><span class="n">scale_pos_weight</span><span class="p">,</span>
    <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">20</span>
<span class="p">)</span>

<span class="n">xgb_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">X_train_scaled</span><span class="p">,</span>
    <span class="n">y_train</span><span class="p">,</span>
    <span class="n">eval_set</span><span class="o">=</span><span class="p">[(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)],</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="c1"># 7. Predictions and Evaluation</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Evaluating model performance...&quot;</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">xgb_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
<span class="n">y_pred_proba</span> <span class="o">=</span> <span class="n">xgb_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">precision</span> <span class="o">=</span> <span class="n">precision_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">recall</span> <span class="o">=</span> <span class="n">recall_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f1</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">zero_division</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred_proba</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model Performance Evaluation on 2015-2019 Test Set&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy:         </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision:        </span><span class="si">{</span><span class="n">precision</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall:           </span><span class="si">{</span><span class="n">recall</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1 Score:         </span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUC Score:        </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Classification Report:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">classification_report</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">target_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;No Drop&#39;</span><span class="p">,</span> <span class="s1">&#39;Will Drop&#39;</span><span class="p">]))</span>

<span class="c1"># Confusion matrix</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Confusion Matrix:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>

<span class="c1"># Visualize confusion matrix</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
    <span class="n">cm</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span>
    <span class="n">xticklabels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Predicted: No Drop&#39;</span><span class="p">,</span> <span class="s1">&#39;Predicted: Will Drop&#39;</span><span class="p">],</span>
    <span class="n">yticklabels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Actual: No Drop&#39;</span><span class="p">,</span> <span class="s1">&#39;Actual: Will Drop&#39;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Confusion Matrix - 2015-2019 Predictions&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;True Label&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted Label&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 8. Feature Importance Analysis</span>
<span class="n">feature_importance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;feature&#39;</span><span class="p">:</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
    <span class="s1">&#39;importance&#39;</span><span class="p">:</span> <span class="n">xgb_model</span><span class="o">.</span><span class="n">feature_importances_</span>
<span class="p">})</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;importance&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Feature Importance Analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top 20 Most Important Features:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">feature_importance</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Visualize feature importance</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">top_n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_importance</span><span class="p">))</span>
<span class="n">top_features</span> <span class="o">=</span> <span class="n">feature_importance</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">top_n</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">barh</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_features</span><span class="p">)),</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_features</span><span class="p">)),</span> <span class="n">top_features</span><span class="p">[</span><span class="s1">&#39;feature&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Feature Importance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;XGBoost Feature Importance (Top </span><span class="si">{</span><span class="n">top_n</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 9. Save Model and Related Objects</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Saving model and related objects...&quot;</span><span class="p">)</span>
<span class="n">model_info</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">xgb_model</span><span class="p">,</span>
    <span class="s1">&#39;scaler&#39;</span><span class="p">:</span> <span class="n">scaler</span><span class="p">,</span>
    <span class="s1">&#39;vectorizer&#39;</span><span class="p">:</span> <span class="n">vectorizer</span> <span class="k">if</span> <span class="s1">&#39;vectorizer&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;numeric_features&#39;</span><span class="p">:</span> <span class="n">numeric_features</span><span class="p">,</span>
    <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy</span><span class="p">,</span>
    <span class="s1">&#39;precision&#39;</span><span class="p">:</span> <span class="n">precision</span><span class="p">,</span>
    <span class="s1">&#39;recall&#39;</span><span class="p">:</span> <span class="n">recall</span><span class="p">,</span>
    <span class="s1">&#39;f1&#39;</span><span class="p">:</span> <span class="n">f1</span><span class="p">,</span>
    <span class="s1">&#39;auc&#39;</span><span class="p">:</span> <span class="n">auc</span><span class="p">,</span>
    <span class="s1">&#39;train_years&#39;</span><span class="p">:</span> <span class="s1">&#39;2008-2014&#39;</span><span class="p">,</span>
    <span class="s1">&#39;test_years&#39;</span><span class="p">:</span> <span class="s1">&#39;2015-2019&#39;</span><span class="p">,</span>
    <span class="s1">&#39;feature_names&#39;</span><span class="p">:</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model_info</span><span class="p">,</span> <span class="s1">&#39;xgb_sp500_2008_2014_model.pkl&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model saved as &#39;xgb_sp500_2008_2014_model.pkl&#39;&quot;</span><span class="p">)</span>

<span class="c1"># 10. Yearly and Monthly Analysis of Predictions</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Yearly and Monthly Prediction Results Analysis&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="c1"># Add predictions to test data</span>
<span class="n">test_data_with_pred</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">test_data_with_pred</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span>
<span class="n">test_data_with_pred</span><span class="p">[</span><span class="s1">&#39;prediction_probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred_proba</span>
<span class="n">test_data_with_pred</span><span class="p">[</span><span class="s1">&#39;prediction_correct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">test_data_with_pred</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">test_data_with_pred</span><span class="p">[</span><span class="s1">&#39;sp500_drop_8pct_next_3m&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Yearly statistics</span>
<span class="n">test_data_with_pred</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_data_with_pred</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
<span class="n">yearly_stats</span> <span class="o">=</span> <span class="n">test_data_with_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
    <span class="s1">&#39;sp500_drop_8pct_next_3m&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prediction_correct&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prediction_probability&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span>
<span class="p">})</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;sp500_drop_8pct_next_3m&#39;</span><span class="p">:</span> <span class="s1">&#39;actual_drop_count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="s1">&#39;predicted_drop_count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prediction_correct&#39;</span><span class="p">:</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prediction_probability&#39;</span><span class="p">:</span> <span class="s1">&#39;avg_prediction_probability&#39;</span>
<span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Yearly Statistics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">yearly_stats</span><span class="p">)</span>

<span class="c1"># Monthly statistics</span>
<span class="n">test_data_with_pred</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_data_with_pred</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
<span class="n">monthly_stats</span> <span class="o">=</span> <span class="n">test_data_with_pred</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span>
    <span class="s1">&#39;sp500_drop_8pct_next_3m&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prediction_correct&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prediction_probability&#39;</span><span class="p">:</span> <span class="s1">&#39;mean&#39;</span>
<span class="p">})</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;sp500_drop_8pct_next_3m&#39;</span><span class="p">:</span> <span class="s1">&#39;actual_drop_count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prediction&#39;</span><span class="p">:</span> <span class="s1">&#39;predicted_drop_count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prediction_correct&#39;</span><span class="p">:</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;prediction_probability&#39;</span><span class="p">:</span> <span class="s1">&#39;avg_prediction_probability&#39;</span>
<span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Monthly Statistics:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">monthly_stats</span><span class="p">)</span>

<span class="c1"># Visualize yearly and monthly accuracy</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">yearly_stats</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">yearly_stats</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Overall Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;2015-2019 Yearly Prediction Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">monthly_stats</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">monthly_stats</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Overall Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Month&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;2015-2019 Monthly Prediction Accuracy&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Visualize positive class proportion over time</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># Training set positive class proportion</span>
<span class="n">train_yearly_pos_rate</span> <span class="o">=</span> <span class="n">train_year_stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">train_yearly_pos_rate</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">train_yearly_pos_rate</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Training Avg: </span><span class="si">{</span><span class="n">y_train</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Positive Class Proportion&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Training Set (2008-2014) - Positive Class Proportion by Year&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Test set positive class proportion</span>
<span class="n">test_yearly_pos_rate</span> <span class="o">=</span> <span class="n">test_year_stats</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">test_yearly_pos_rate</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">test_yearly_pos_rate</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span>
    <span class="n">y</span><span class="o">=</span><span class="n">y_test</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Test Avg: </span><span class="si">{</span><span class="n">y_test</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Positive Class Proportion&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Test Set (2015-2019) - Positive Class Proportion by Year&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model Training and Evaluation Complete!&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trained on 2008-2014 data (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tested on 2015-2019 data (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final F1 Score: </span><span class="si">{</span><span class="n">f1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Model saved and ready for predicting new data&quot;</span><span class="p">)</span>
</code></pre></div>

<h3>4.4 Reflections and Limitations</h3>
<p>This modeling stage reinforced several lessons:</p>
<p>Time-based evaluation is stricter but more honest. Performance usually drops compared to random split, but the result is more credible.</p>
<p>Rare-event prediction is inherently hard. A high accuracy can be misleading if the model simply predicts “no crash” most of the time.</p>
<p>Interpretability matters. Even when performance is not perfect, understanding which text signals drive predictions is valuable for building a defensible warning framework.</p>
<p>Overall, this step helped us close the loop from “text signals” to “actionable warning indicators,” while staying cautious about over-claiming predictive power.</p>
<h2>5. Modeling: SVM</h2>
<p>After the modeling stage with XGBoost, we achieved a good performance, especially excelling in handling high-dimensional and non-linear features. However, as an ensemble learning method, XGBoost, while powerful in prediction, can sometimes be prone to overfitting and has longer training times. To gain a more comprehensive evaluation of the model performance, we decided to benchmark Support Vector Machine (SVM) as a baseline model.</p>
<p>SVM is a classic binary classification model that performs particularly well with high-dimensional data and excels in some simple linear classification tasks. Compared to XGBoost, SVM requires fewer hyperparameter adjustments during training and is more computationally efficient. Therefore, when computational resources are limited or rapid prototyping is needed, SVM is a good choice. By comparing the performance of XGBoost and SVM, we can better understand the strengths and limitations of each model when handling our dataset, helping us make a more informed model selection.</p>
<h3>5.1. XGBoost vs SVM: Benchmark Comparison</h3>
<p><strong>To contextualize the performance of XGBoost, we benchmark it against a Support
Vector Machine (SVM)</strong>, a widely used and well-established classification model
that serves as a strong baseline in financial prediction tasks. Both models are
trained and evaluated on identical datasets using the <strong>same time-based
train–test split and consistent preprocessing procedures</strong>.</p>
<h5>5.1.1 SVM: Core Principles</h5>
<p>Support Vector Machine is a powerful supervised learning algorithm originally
designed for binary classification. Its core idea is to find an <strong>optimal</strong>
hyperplane in the feature space that maximizes the margin between two classes.</p>
<p>The SVM optimization objective can be expressed as:</p>
<div class="math">$$\min_{w,b} \frac{1}{2}\|w\|^2 \quad \text{s.t.} \quad y_i(w \cdot x_i + b) \geq 1, \forall i$$</div>
<p>where <span class="math">\(w\)</span> is the normal vector of the hyperplane, <span class="math">\(b\)</span> is the bias term, and
<span class="math">\(y_i \in \{-1, +1\}\)</span> represents the class labels.</p>
<p>For data that is not linearly separable, SVM uses the <strong>Kernel Trick</strong> to map
original features into a higher-dimensional space where the data becomes
linearly separable. Common kernel functions include <strong>Linear</strong>, <strong>RBF</strong>,
<strong>Polynomial</strong> and <strong>Sigmoid</strong>.</p>
<h3>5.1.2 SVM: Experimental Design</h3>
<h5>5.1.2.1 Data Preprocessing</h5>
<p>Consistent with the XGBoost model, all features were processed using the same
pipeline to eliminate the effect of differing feature scales.</p>
<h4>5.1.2.2 Kernel Selection Experiment</h4>
<p>To select the optimal kernel function, we performed <strong>GridSearch</strong>
hyperparameter tuning for all four kernels. The search space included
regularization parameter C for all kernels, with kernel-specific parameters
(gamma for RBF/sigmoid, degree for polynomial). For example, the RBF parameter
grid:</p>
<div class="highlight"><pre><span></span><code><span class="n">kernels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;rbf&#39;</span><span class="p">,</span> <span class="s1">&#39;poly&#39;</span><span class="p">,</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">]</span>

<span class="c1"># Parameter grid for RBF kernel</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">],</span>
    <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0005</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<p>We used <strong>TimeSeriesSplit</strong> for cross-validation (3 folds) to ensure the
training process respects temporal ordering and prevents data leakage. The
implementation is as follows: </p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">TimeSeriesSplit</span><span class="p">,</span> <span class="n">GridSearchCV</span>

<span class="n">kernels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;rbf&#39;</span><span class="p">,</span> <span class="s1">&#39;poly&#39;</span><span class="p">,</span> <span class="s1">&#39;sigmoid&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kernels</span><span class="p">:</span>
    <span class="n">tscv</span> <span class="o">=</span> <span class="n">TimeSeriesSplit</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span>
        <span class="n">estimator</span><span class="o">=</span><span class="n">SVC</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">class_weight</span><span class="o">=</span><span class="s1">&#39;balanced&#39;</span><span class="p">,</span> <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
        <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span>
        <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">,</span>
        <span class="n">cv</span><span class="o">=</span><span class="n">tscv</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
    <span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">svm_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>
</code></pre></div>

<p>Following <strong>GridSearch</strong>
optimization, the optimal performance achieved by each kernel is presented
below:</p>
<p><img alt="" src="./images/graph1.png"></p>
<h3>5.1.3 SVM: Why We Chose the RBF Kernel</h3>
<p>After systematically comparing all four kernel functions, we selected the
<strong>RBF</strong> kernel for our final model. The key reasons are as follows:</p>
<h4>5.1.3.1 Non-linear Modeling Capability</h4>
<p>Financial markets operate under complex dynamics, where price movements often
exhibit <strong>non-linear relationships</strong> with various factors. The RBF kernel maps
data into an infinite-dimensional feature space, enabling it to capture these
complex non-linear patterns effectively.</p>
<h4>5.1.3.2 Robustness and Generalization</h4>
<p>The RBF kernel possesses a <strong>locality property</strong>. This characteristic makes the
model: <strong>(1)</strong> more robust to noisy data, <strong>(2)</strong> less prone to overfitting to
extreme values in the training set <strong>and (3)</strong> more stable on unseen test data.</p>
<h4>5.1.3.3 Parameter Tunability</h4>
<p>The RBF kernel has two key hyperparameters:</p>
<ul>
<li><strong>C (Regularization parameter)</strong>: Controls the trade-off between
  classification errors and margin size</li>
<li><strong>γ (Gamma)</strong>: Controls the influence range of individual samples</li>
</ul>
<p>Compared to the polynomial kernel, which requires tuning the degree parameter,
the RBF kernel's parameter space is easier to search and shows relatively lower
sensitivity to parameter changes.</p>
<h4>5.1.3.4 Why Not Linear Kernel</h4>
<p>Although the linear kernel achieved performance comparable to the RBF kernel, we
ultimately selected the RBF kernel. Given the inherently non-linear nature of
financial market dynamics, the flexibility of the RBF kernel allows it to better
capture complex relationships and adapt to potential regime changes. Therefore,
in the presence of similar empirical performance, the RBF kernel was preferred
for its stronger theoretical suitability and expected robustness in
out-of-sample settings.</p>
<h3>5.1.4 SVM: Model Performance</h3>
<h4>5.1.4.1 Evaluation Metrics</h4>
<p>We evaluated model performance on the 2015–2019 test set using the metrics same
as XGBoost, including <strong>Accuracy</strong>, <strong>Precision</strong>, <strong>Recall</strong>, <strong>F1-Score</strong> and
<strong>AUC</strong>.</p>
<h4>5.1.4.2 Confusion Matrix Analysis</h4>
<p>Under the <strong>RBF kernel with the optimal hyperparameter</strong> configuration, the
confusion matrix illustrates the model’s classification behavior across
different outcome categories. The <strong>True Positive Rate</strong> and <strong>False Positive
Rate</strong> are as below:</p>
<p><img alt="" src="./images/graph2.png"></p>
<h4>5.1.4.3 Threshold Tuning</h4>
<p>We also plotted the <strong>Precision-Recall Curve</strong> and <strong>Performance threshold</strong> to
analyze model performance under different thresholds, providing guidance for
threshold selection in practical applications.</p>
<p><img alt="" src="./images/graph3.png"></p>
<p><img alt="" src="./images/graph4.png"></p>
<h3>5.1.5 XGBoost vs SVM: Model Comparison</h3>
<p>We conducted a comprehensive comparison across the following dimensions:</p>
<ol>
<li><strong>Overall Metrics Comparison</strong>: As shown below, XGBoost achieves higher
   scores across all three key metrics: Accuracy, F1, and AUC.</li>
</ol>
<p><img alt="" src="./images/graph5.png"></p>
<ol>
<li><strong>Superior ROC Curve</strong>: The ROC curve comparison reveals that XGBoost (AUC =
   0.907) significantly outperforms SVM (AUC = 0.856), demonstrating better
   discrimination ability between positive and negative samples across all
   classification thresholds.</li>
</ol>
<p><img alt="" src="./images/graph6.png"></p>
<ol>
<li><strong>Better Precision-Recall Trade-off</strong>: XGBoost achieves substantially higher
   Average Precision (AP = 0.525) compared to SVM (AP = 0.329), indicating
   stronger performance in handling class imbalance.</li>
</ol>
<p><img alt="" src="./images/graph7.png"></p>
<ol>
<li><strong>Confusion Matrix Analysis</strong>: Both models show high accuracy on the majority
   class ("No Drop"), with XGBoost achieving 96.85% versus SVM's 93.62%. For the
   minority class ("Drop"), both models exhibit similar recall rates
   (approximately 52-53%), reflecting the inherent challenge of predicting
   market drops.</li>
</ol>
<p><img alt="" src="./images/graph8.png"></p>
<h3>5.1.6 Conclusion</h3>
<p>This benchmark comparison demonstrates that <strong>XGBoost outperforms SVM on most
metrics</strong> for S&amp;P 500 market drop prediction. While SVM serves as a
well-established baseline, our comprehensive evaluation reveals clear
performance gaps across key metrics:</p>
<table>
<thead>
<tr>
<th>Metric</th>
<th>XGBoost</th>
<th>SVM (RBF)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Accuracy</td>
<td>0.9448</td>
<td>0.9148</td>
</tr>
<tr>
<td>AUC</td>
<td>0.9069</td>
<td>0.8562</td>
</tr>
<tr>
<td>Precision</td>
<td>0.4778</td>
<td>0.3158</td>
</tr>
<tr>
<td>Recall</td>
<td>0.5181</td>
<td>0.5301</td>
</tr>
<tr>
<td>F1</td>
<td>0.4971</td>
<td>0.3958</td>
</tr>
</tbody>
</table>
<p>XGBoost's dominance stems from its <strong>ensemble learning architecture</strong>, which
automatically captures complex feature interactions and handles class imbalance
more effectively than SVM's implicit kernel mapping.</p>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2026-01-21T00:00:00+08:00">Wed 21 January 2026</time>
            <h4>Category</h4>
            <a class="category-link" href="https://buehlmaier.github.io/MFIN7036-student-blog-2025-12/categories.html#reflective-report-ref">Reflective Report</a>
<h4>Contact</h4>
<div id="sidebar-social-link">
    <a href="https://github.com/buehlmaier/MFIN7036-student-blog-2025-12" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="https://buehlmaier.github.io/MFIN7036-student-blog-2025-12/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>